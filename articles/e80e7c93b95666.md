---
title: "Rust vs. Go: Effective Unit Testing"
emoji: "ğŸ…"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust","go","test","devcontainer"]
published: false
---
[Retail AI Adventurers Advent Calendar 2023](https://qiita.com/advent-calendar/2023/rai-adventurers) ã®æŠ•ç¨¿ã§ã™ã€‚

https://qiita.com/advent-calendar/2023/rai-adventurers

[Retail AI](https://www.retail-ai.jp) ã¯ã€[ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼](https://www.trial-net.co.jp) ã‚’è»¸ã¨ã—ãŸå°å£²ã«ãŠã‘ã‚‹ãŠå®¢æ§˜ã®è²·ã„ç‰©ä½“é¨“ã®å‘ä¸Šã‚’ç›®æŒ‡ã™ä¼æ¥­ã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã§ã¯ã€æœ¬æ¥­ï¼ˆSREï¼‰ã®ã‹ãŸã‚ã‚‰ã§å–ã‚Šçµ„ã‚€ Backend ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

é¡Œæã¯ã€Rust åˆå¿ƒè€…ã¨ã—ã¦ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦ã§ã™ã€‚

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…å¯èƒ½ã«ã™ã‚‹ãŸã‚ã«ã€ä¾å­˜é–¢ä¿‚ã®é€†è»¢ï¼ˆDIï¼‰ã‚’å–ã‚Šå…¥ã‚Œã‚‹æ–¹æ³•ã‚’æ›¸ãã¾ã—ãŸã€‚

ãã‚Œã‚’å…ƒã« Test Code ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

Rust ã§ Table Driven Tests[^1] ã¯ã©ã†ãªã‚‹ã‹ï¼Ÿ

https://github.com/danny-yamamoto/rust-api-samples/tree/main/main

https://github.com/danny-yamamoto/go-api-samples

## How to write tests: Rust
### Unit tests and Integration tests
Rust ã«ãŠã‘ã‚‹ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã«ã¤ã„ã¦ã§ã™ã€‚
Unit tests ã¨ Integration tests ã§å®Ÿè£…æ–¹æ³•ãŒç•°ãªã‚Šã¾ã™ã€‚

- Unit tests
logic å†…ã«æ›¸ãã¾ã™ã€‚
Test Code ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹ãŸã‚ã«ã€Annotation `cfg(test)` ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€Official Docs ã‚ˆã‚Šã€‚
> Unit Tests
The purpose of unit tests is to test each unit of code in isolation from the rest of the code to quickly pinpoint where code is and isnâ€™t working as expected. Youâ€™ll put unit tests in the src directory in each file with the code that theyâ€™re testing. The convention is to create a module named tests in each file to contain the test functions and to annotate the module with cfg(test).

https://doc.rust-lang.org/book/ch11-03-test-organization.html?highlight=cfg(test)#unit-tests

`cfg(test)` ã‚’ä»˜ä¸ã™ã‚‹ã®ãŒæ…£ä¾‹ã§ã™ã€‚

Unit Tests ã‚’æ›¸ãã¾ã™ã€‚

```rust:routes.rs
#[cfg(test)]
mod users_service_tests {
    use sqlx::SqlitePool;
    use crate::routes::UserService;

    #[tokio::test]
    async fn test_fetch_users() {
        let pool = SqlitePool::connect("sqlite:./unit_test.db").await.expect("Failed to connect to database.");
        let service = UserService::new(pool);
        let user_id = 10000;
        let result = service.fetch_user(user_id).await;
        assert!(result.is_ok());
        let user = result.unwrap();
        assert!(user.is_some());
        let row = user.unwrap();
        assert_eq!(row.email_address, Some("marc@example.com".to_string()));
    }
}
```

Unit Tests ã‚’ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`cargo test`
```bash
vscode âœ /workspaces/rust-api-samples/main (main) $ cargo test
   Compiling main v0.1.0 (/workspaces/rust-api-samples/main)
    Finished test [unoptimized + debuginfo] target(s) in 1m 33s
     Running unittests src/main.rs (target/debug/deps/main-794ccb24f64c7f92)

running 3 tests
test routes::tests::err_api_response_users ... ok
test routes::tests::test_api_response_users ... ok
test routes::users_service_tests::test_fetch_users ... ok      # ã“ã‚Œ

test result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.27s

vscode âœ /workspaces/rust-api-samples/main (main) $
```

### Table Driven Tests in Rust
Table Driven Tests ã‚’ Rust ã§å®Ÿè·µã™ã‚‹ã¨ã©ã†ãªã‚‹ã‹ã€‚
ã“ã‚Œã¯ã€è«¸å…ƒãŒã‚ã‚‹ã‚ã‘ã§ã¯ãªãã€å€‹äººçš„ã«è€ƒãˆãŸå®Ÿè£…æ–¹æ³•ã§ã™ã€‚

```rust:routes.rs
#[cfg(test)]
mod users_service_tests {
    use serde::{Serialize, Deserialize};
    use sqlx::SqlitePool;
    use crate::routes::UserService;

    #[derive(Debug, Serialize, Deserialize)]
    struct TestCase {
		name: String,
		user_id: i64,
		expected_json: String,
    }

    #[tokio::test]
    async fn tdt_fetch_users() {
        let pool = SqlitePool::connect("sqlite:./unit_test.db").await.expect("Failed to connect to database.");
        let service = UserService::new(pool);
        let tests = vec![
            TestCase { name: "Normal pattern a".to_string(), user_id: 10000, expected_json: "{\"user_id\":10000,\"email_address\":\"marc@example.com\",\"created_at\":0,\"deleted\":1,\"settings\":\"\"}".to_string() },
            TestCase { name: "Normal pattern b".to_string(), user_id: 100, expected_json: "{\"user_id\":100,\"email_address\":\"alex@example.com\",\"created_at\":1,\"deleted\":0,\"settings\":\"\"}".to_string() }
        ];

        for tc in tests {
            let user_id = tc.user_id;
            let result = service.fetch_user(user_id).await;
            assert!(result.is_ok());
            let user_data = result.unwrap();
            let user_json = serde_json::to_string(&user_data).expect("error");
            assert_eq!(user_json, tc.expected_json, "Failed: {}", tc.name);
        }
    }
}
```

```bash
vscode âœ /workspaces/rust-api-samples/main (main) $ cargo test
   Compiling main v0.1.0 (/workspaces/rust-api-samples/main)
    Finished test [unoptimized + debuginfo] target(s) in 1m 36s
     Running unittests src/main.rs (target/debug/deps/main-794ccb24f64c7f92)

running 4 tests
test routes::tests::err_api_response_users ... ok
test routes::tests::test_api_response_users ... ok
test routes::users_service_tests::test_fetch_users ... ok
test routes::users_service_tests::tdt_fetch_users ... ok             # ã“ã‚Œ

test result: ok. 4 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.28s

vscode âœ /workspaces/rust-api-samples/main (main) $ 
```

## How to write tests: Go
Go ã® test ã¯ã€è¨€ã‚ãšã¨çŸ¥ã‚ŒãŸ `Table Driven Tests`ã€‚
mock[^2] ã¨ã—ã¦ã€database ã‚’å…ˆã«ç”¨æ„ã—ã¾ã™ã€‚
`setupMockDB` ã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹ã®ã‚‚ã‚ã‚Šã€‚ã‚‚ã—ãã¯ã€db ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãŠãã¾ã™ã€‚

```bash
sqlite3 unit_test.db
```

```go
package users

import (
	"database/sql"
	"encoding/json"
	"strconv"
	"testing"
)

func setupMockDB(t *testing.T) *sql.DB {
	db, err := sql.Open("sqlite3", "../../unit_test.db")
	if err != nil {
		t.Fatalf("Failed to connect to database: %v", err)
	}
	return db
}

func TestGetUsers(t *testing.T) {
	db := setupMockDB(t)

	tests := []struct {
		name         string
		userId       int64
		expectedJSON string
		want         bool
	}{
		{"Normal pattern a", 10000, `{"user_id":10000,"email_address":"marc@example.com","created_at":0,"deleted":1,"settings":""}`, true},
		{"Normal pattern b", 100, `{"user_id":100,"email_address":"marc@example.com","created_at":1,"deleted":1,"settings":""}`, false},
		{"Failed pattern a", 100, `{"user_id":100,"email_address":"alex@example.com","created_at":1,"deleted":0,"settings":""}`, true},
	}
	for _, tc := range tests {
		user, err := GetUsers(db, UserQuery{UserId: strconv.FormatInt(tc.userId, 10)})
		if err != nil {
			t.Errorf("Error: %v", err)
		}
		userJson, err := json.Marshal(user)
		if err != nil {
			t.Errorf("Failed to marshal user data: %s", err)
		}
		if tc.want && string(userJson) != tc.expectedJSON {
			t.Errorf("Expected JSON %s for user ID %v, got %s", tc.expectedJSON, tc.userId, string(userJson))
		}
	}

}
```

ç°¡å˜ã§ã™ãŒã€Test Code ã«ã¤ã„ã¦ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ä½•ã‹å¾—ã‚‰ã‚ŒãŸæ–¹ã¯ã€ã„ã„ã­ â¤ï¸ ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯ã€æ¬¡å›ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚ğŸ‘‹

## BTW

[^1]: https://dave.cheney.net/2019/05/07/prefer-table-driven-tests
[^2]: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§ä½¿ã‚ã‚Œã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã®ä¸€ã¤ã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®ä¸€éƒ¨åˆ†ï¼ˆä¾‹ãˆã°å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã‚’æ¨¡æ“¬ã™ã‚‹ã€Œãƒ¢ãƒƒã‚¯ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã‚’ä½œæˆã—ã€æœ¬ç‰©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä»£ã‚ã‚Šã«ä½¿ç”¨ã—ã¾ã™ã€‚
