---
title: "Rust vs. Go: Implementing DI for Effective Unit Testing"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---
Rust åˆå¿ƒè€…ã¨ã—ã¦ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦å­¦ã¶ã€‚

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…å¯èƒ½ã«ã™ã‚‹ãŸã‚ã«ã€ä¾å­˜é–¢ä¿‚ã®é€†è»¢ï¼ˆDIï¼‰ã‚’å–ã‚Šå…¥ã‚Œã‚‹ã€‚DI ã¯ã€ã©ã®é–‹ç™ºè¨€èªã§ã‚‚ä½¿ãˆã‚‹ã€‚

ãã—ã¦ã€æ§‹æˆã‚’å¤‰æ›´ã™ã‚‹ã€‚`main.rs` ã¯ entorypointã€‚handler ã¨æ§‹é€ ä½“ã‚’ `routes.rs`ã€`model.rs` ã«åˆ†ã‘ã‚‹ã€‚

ã“ã‚Œã§ã€Unit test code ã‚’è¿½åŠ ã™ã‚‹æº–å‚™ãŒå®Œäº†ã€‚

ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/danny-yamamoto/rust-api-samples/tree/main/main

https://github.com/danny-yamamoto/go-api-samples

## Rust
- How to write tests
Rust ã«ãŠã‘ã‚‹ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã«ã¤ã„ã¦ã€‚
Unit tests ã¨ Integration tests ã® 2ã¤ã‚ã‚‹ã€‚

- Unit tests
logic å†…ã«æ›¸ãã€‚
test code ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹ãŸã‚ã«ã€annotation `cfg(test)` ã‚’ä»˜ä¸ã™ã‚‹ã€‚

> Unit Tests
The purpose of unit tests is to test each unit of code in isolation from the rest of the code to quickly pinpoint where code is and isnâ€™t working as expected. Youâ€™ll put unit tests in the src directory in each file with the code that theyâ€™re testing. The convention is to create a module named tests in each file to contain the test functions and to annotate the module with cfg(test).

https://doc.rust-lang.org/book/ch11-03-test-organization.html?highlight=cfg(test)#unit-tests

`cfg(test)` ã‚’ä»˜ä¸ã™ã‚‹ã®ãŒæ…£ä¾‹ã¨ã„ã†ã“ã¨ã€‚

è©¦ã—ã« unit tests ã‚’æ›¸ãã€‚

```rust:routes.rs
#[cfg(test)]
mod tests {
    use super::*;

    #[tokio::test]
    async fn test_api_response_users() {
        let user = User {
            user_id: 9999,
            email_address: Some("hoge@example.com".to_string()),
            created_at: Some(0),
            deleted: Some(0),
            settings: Some("option".to_string()),
        };
        let response = ApiResponse::UserResponse(Some(user)).into_response();
        assert_eq!(response.status(), StatusCode::OK);
    }
}
```

ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
```bash
vscode âœ /workspaces/rust-api-samples/main (main) $ cargo test
    Finished test [unoptimized + debuginfo] target(s) in 2.66s
     Running unittests src/main.rs (target/debug/deps/main-794ccb24f64c7f92)

running 1 test
test routes::tests::test_api_response_users ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

vscode âœ /workspaces/rust-api-samples/main (main) $ 
```

ã¾ãŸã€Unit tests ã‚’ VS Code ã®ç”»é¢ã‹ã‚‰å®Ÿè¡Œã§ãã‚‹ã€‚
![unit test](image.png)

å®Ÿè£…ã®æ‰‹é †
1. 

## Go
è¨€ã‚ãšã¨çŸ¥ã‚ŒãŸ Table Driven Testsã€‚
mock ã¨ã—ã¦ã€database ã‚’å…ˆã«ç”¨æ„ã—ã¦ãŠãã€‚
`setupMockDB` ã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹ã®ã‚‚ã‚ã‚Šã€‚ã‚‚ã—ãã¯ã€db ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãŠãã€‚

```bash
sqlite3 unit_test.db
```

```go
package users

import (
	"database/sql"
	"encoding/json"
	"strconv"
	"testing"
)

func setupMockDB(t *testing.T) *sql.DB {
	db, err := sql.Open("sqlite3", "../../unit_test.db")
	if err != nil {
		t.Fatalf("Failed to connect to database: %v", err)
	}
	return db
}

func TestGetUsers(t *testing.T) {
	db := setupMockDB(t)

	tests := []struct {
		name         string
		userId       int64
		expectedJSON string
		want         bool
	}{
		{"Normal pattern a", 10000, `{"user_id":10000,"email_address":"marc@example.com","created_at":0,"deleted":1,"settings":""}`, true},
		{"Normal pattern b", 100, `{"user_id":100,"email_address":"marc@example.com","created_at":1,"deleted":1,"settings":""}`, false},
		{"Failed pattern a", 100, `{"user_id":100,"email_address":"alex@example.com","created_at":1,"deleted":0,"settings":""}`, true},
	}
	for _, tc := range tests {
		user, err := GetUsers(db, UserQuery{UserId: strconv.FormatInt(tc.userId, 10)})
		if err != nil {
			t.Errorf("Error: %v", err)
		}
		userJson, err := json.Marshal(user)
		if err != nil {
			t.Errorf("Failed to marshal user data: %s", err)
		}
		if tc.want && string(userJson) != tc.expectedJSON {
			t.Errorf("Expected JSON %s for user ID %v, got %s", tc.expectedJSON, tc.userId, string(userJson))
		}
	}

}
```

## impressions
å®Ÿè·µçš„ãªã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã£ã¦ããŸä¸€æ–¹ã§ã€LeetCode ã® Graph, BFS, DFS ã‚’è¦‹ã¦ã„ã‚‹ã¨ã€algorithm ã«ç‰¹åŒ–ã—ãŸå­¦ç¿’ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ã€ŒRust ã§ãã¾ã™ã€ã¨è¨€ãˆã‚‹ã¾ã§ã«ã¯ã‚‚ã†å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šãã†ã€‚
