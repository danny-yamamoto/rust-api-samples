---
title: "Rust vs. Go: Effective Unit Testing"
emoji: "ğŸ…"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["rust","go","test","devcontainer"]
published: false
---
[Retail AI Adventurers Advent Calendar 2023](https://qiita.com/advent-calendar/2023/rai-adventurers) ã®æŠ•ç¨¿ã§ã™ã€‚

https://qiita.com/advent-calendar/2023/rai-adventurers

[Retail AI](https://www.retail-ai.jp) ã¯ã€[ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼](https://www.trial-net.co.jp) ã‚’è»¸ã¨ã—ãŸå°å£²ã«ãŠã‘ã‚‹ãŠå®¢æ§˜ã®è²·ã„ç‰©ä½“é¨“ã®å‘ä¸Šã‚’ç›®æŒ‡ã™ä¼æ¥­ã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã§ã¯ã€æœ¬æ¥­ï¼ˆSREï¼‰ã®ã‹ãŸã‚ã‚‰ã§å–ã‚Šçµ„ã‚€ Backend Tech Stack ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

é¡Œæã¯ã€ã€ŒRust åˆå¿ƒè€…ã¨ã—ã¦ã€Standard ãª Test Code ã®å®Ÿè£…æ–¹æ³•ã€ã«ã¤ã„ã¦ã§ã™ã€‚

Rust ã«ãŠã‘ã‚‹ Test Code ã®æ›¸ãæ–¹ã¨ Go ã§ä¸€èˆ¬çš„ãª Table Driven Tests[^1] ã‚’ä½¿ã£ãŸ Test Code ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚

## tl;dr
* Rust ã§ã‚‚ Go ã¨åŒã˜ã‚ˆã†ãª Table Driven Tests[^1] ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚
* Rust ã§ã¯ã€compile æ™‚ã«å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ãŸã‚ã€Test Case ã®è¨­è¨ˆã‚‚ã‚ˆã‚Šå³å¯†ã«ãªã‚Šã¾ã™ã€‚
* Rust ã§ã¯ã€Unit tests ã¨ Integration tests ã§å®Ÿè£…æ–¹æ³•ãŒç•°ãªã‚Šã¾ã™ã€‚
* ã“ã®æŠ•ç¨¿ã¨ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ãŒã€åŒæ—¥ã«åˆ¥ã®ã‚¢ãƒ‰ã‚«ãƒ¬[^3] ã«æŠ•ç¨¿ã—ã¦ã„ã¾ã™ã€‚

## How to write tests: Rust
### Unit tests and Integration tests
Rust ã§ã¯ã€Unit tests ã¨ Integration tests ã§å®Ÿè£…æ–¹æ³•ãŒç•°ãªã‚Šã¾ã™ã€‚

#### Unit tests
logic å†…ã«æ›¸ãã¾ã™ã€‚
Test Code ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹ãŸã‚ã«ã€Annotation `cfg(test)` ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€Official Docs ã‚ˆã‚Šã€‚
> **Unit Tests**
The purpose of unit tests is to test each unit of code in isolation from the rest of the code to quickly pinpoint where code is and isnâ€™t working as expected. Youâ€™ll put unit tests in the src directory in each file with the code that theyâ€™re testing. The convention is to create a module named tests in each file to contain the test functions and to annotate the module with cfg(test).
>
> ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ç›®çš„ã¯ã€ã‚³ãƒ¼ãƒ‰ã®å„ãƒ¦ãƒ‹ãƒƒãƒˆã‚’ä»–ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ã¦ãƒ†ã‚¹ãƒˆã—ã€ã‚³ãƒ¼ãƒ‰ãŒæœŸå¾…é€šã‚Šã«å‹•ã„ã¦ã„ã‚‹ã¨ã“ã‚ã¨å‹•ã„ã¦ã„ãªã„ã¨ã“ã‚ã‚’ç´ æ—©ãçªãæ­¢ã‚ã‚‹ã“ã¨ã§ã™ã€‚ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯ã€ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ã‚ã‚‹å„ãƒ•ã‚¡ã‚¤ãƒ«ã® src ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ãã¾ã™ã€‚å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã«testsã¨ã„ã†åå‰ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆé–¢æ•°ã‚’æ ¼ç´ã—ã€cfg(test)ã¨ã„ã†ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã®ãŒæ…£ä¾‹ã§ã™ã€‚

#### Integration tests
`tests` directory ã«æ›¸ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€Official Docs ã‚ˆã‚Šã€‚

> **Integration Tests**
In Rust, integration tests are entirely external to your library. They use your library in the same way any other code would, which means they can only call functions that are part of your libraryâ€™s public API. Their purpose is to test whether many parts of your library work together correctly. Units of code that work correctly on their own could have problems when integrated, so test coverage of the integrated code is important as well. To create integration tests, you first need a tests directory.
> 
> Rustã§ã¯ã€çµ±åˆãƒ†ã‚¹ãƒˆã¯å®Œå…¨ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å¤–éƒ¨ã§ã™ã€‚ã¤ã¾ã‚Šã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯APIã®ä¸€éƒ¨ã§ã‚ã‚‹é–¢æ•°ã®ã¿ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚çµ±åˆãƒ†ã‚¹ãƒˆã®ç›®çš„ã¯ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å¤šãã®éƒ¨åˆ†ãŒæ­£ã—ãé€£æºã—ã¦å‹•ä½œã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚å˜ä½“ã§ã¯æ­£ã—ãå‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚‚ã€çµ±åˆã™ã‚‹ã¨å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚çµ±åˆãƒ†ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ã¾ãš tests ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå¿…è¦ã§ã™ã€‚

```bash
adder
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ src
â”‚Â Â  â””â”€â”€ lib.rs
â””â”€â”€ tests                            # Here
    â””â”€â”€ integration_test.rs          # Here
```

https://doc.rust-lang.org/book/ch11-03-test-organization.html?highlight=cfg(test)#unit-tests

Unit tests ã«ã¤ã„ã¦ã€è©³ã—ãè¦‹ã¦ã„ãã¾ã™ã€‚

ã¾ãšã€Unit tests ã¯ã€`cfg(test)` ã‚’ä»˜ä¸ã™ã‚‹ã®ãŒæ…£ä¾‹ã§ã™ã€‚

ä»¥ä¸‹ã€sample code ã§ã™ã€‚

https://github.com/danny-yamamoto/rust-api-samples/blob/e1062ae0c951e3be676d2ab8fb61341893437fe7/main/src/routes.rs#L105-L116

Unit Tests ã‚’ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚`cargo test`
```bash
vscode âœ /workspaces/rust-api-samples/main (main) $ cargo test
   Compiling main v0.1.0 (/workspaces/rust-api-samples/main)
    Finished test [unoptimized + debuginfo] target(s) in 1m 33s
     Running unittests src/main.rs (target/debug/deps/main-794ccb24f64c7f92)

running 3 tests
test routes::tests::err_api_response_users ... ok
test routes::tests::test_api_response_users ... ok
test routes::users_service_tests::test_fetch_users ... ok      # Here

test result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.27s

vscode âœ /workspaces/rust-api-samples/main (main) $
```

### Table Driven Tests in Rust
Table Driven Tests[^1] ã‚’ Rust ã§å®Ÿè·µã™ã‚‹ã¨ã©ã†ãªã‚‹ã‹ã€‚
ã“ã‚Œã¯ã€è«¸å…ƒãŒã‚ã‚‹ã‚ã‘ã§ã¯ãªãã€å€‹äººçš„ã«è€ƒãˆãŸå®Ÿè£…æ–¹æ³•ã§ã™ã€‚

Vector å‹ã®é…åˆ—ã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ç”¨æ„ã—ã¾ã™ã€‚

https://github.com/danny-yamamoto/rust-api-samples/blob/e1062ae0c951e3be676d2ab8fb61341893437fe7/main/src/routes.rs#L118-L142

```bash
vscode âœ /workspaces/rust-api-samples/main (main) $ cargo test
   Compiling main v0.1.0 (/workspaces/rust-api-samples/main)
    Finished test [unoptimized + debuginfo] target(s) in 1m 36s
     Running unittests src/main.rs (target/debug/deps/main-794ccb24f64c7f92)

running 4 tests
test routes::tests::err_api_response_users ... ok
test routes::tests::test_api_response_users ... ok
test routes::users_service_tests::test_fetch_users ... ok
test routes::users_service_tests::tdt_fetch_users ... ok             # Here

test result: ok. 4 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.28s

vscode âœ /workspaces/rust-api-samples/main (main) $ 
```

## How to write tests: Go
Go ã® test ã¯ã€è¨€ã‚ãšã¨çŸ¥ã‚ŒãŸ `Table Driven Tests`[^1] ã§ã™ã€‚
mock[^2] ã¨ã—ã¦ã€database ã‚’å…ˆã«ç”¨æ„ã—ã¾ã™ã€‚
`setupMockDB` ã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹ã®ã‚‚ã‚ã‚Šã€‚ã‚‚ã—ãã¯ã€db ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãŠãã¾ã™ã€‚

https://github.com/danny-yamamoto/go-api-samples/blob/2958a4e8919e5b55f2c164a24e7a6346cd5d07d4/internal/users/users_test.go#L18-L43

ä»Šå›å®Ÿè£…ã—ãŸ Code ã¯ã€ä»¥ä¸‹ã§ã™ã€‚

https://github.com/danny-yamamoto/rust-api-samples/tree/main/main

https://github.com/danny-yamamoto/go-api-samples

ç°¡å˜ã§ã™ãŒã€Test Code ã«ã¤ã„ã¦ã¯ä»¥ä¸Šã§ã™ã€‚

ã“ã®æŠ•ç¨¿ã‚’ã¿ã¦ä½•ã‹å¾—ã‚‰ã‚ŒãŸæ–¹ã¯ã€ã„ã„ã­ â¤ï¸ ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

ãã‚Œã§ã¯ã€æ¬¡å›ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚ğŸ‘‹

## BTW
ã“ã®æŠ•ç¨¿ã¨ã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ãŒã€åŒæ—¥ã«åˆ¥ã®ã‚¢ãƒ‰ã‚«ãƒ¬ã«æŠ•ç¨¿ã—ã¦ã„ã¾ã™ã€‚

[CCoEã‚¯ãƒªã‚¹ãƒã‚¹ï¼ã‚¯ãƒ©ã‚¦ãƒ‰æŠ€è¡“ã‚’æ´»ç”¨ã—ã¦çµ„ç¹”ã‚’ã‚«ã‚¤ã‚¼ãƒ³ã—ãŸäº‹ä¾‹ã‚’æŠ•ç¨¿ã—ã‚ˆã†ï¼ by KINTOãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º Advent Calendar 2023](https://qiita.com/advent-calendar/2023/kinto-technlogies)

https://qiita.com/advent-calendar/2023/kinto-technlogies

2023å¹´11æœˆã« GA ã«ãªã£ãŸåˆæˆãƒ¢ãƒ‹ã‚¿ãƒ¼ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

ã‚‚ã—ã‚ˆã‚ã—ã‘ã‚Œã°ã€ã“ã¡ã‚‰ã‚‚è¦‹ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

[^1]: https://dave.cheney.net/2019/05/07/prefer-table-driven-tests
[^2]: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§ä½¿ã‚ã‚Œã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã®ä¸€ã¤ã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®ä¸€éƒ¨åˆ†ï¼ˆä¾‹ãˆã°å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã‚’æ¨¡æ“¬ã™ã‚‹ã€Œãƒ¢ãƒƒã‚¯ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã‚’ä½œæˆã—ã€æœ¬ç‰©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä»£ã‚ã‚Šã«ä½¿ç”¨ã—ã¾ã™ã€‚
[^3]: https://qiita.com/advent-calendar/2023/kinto-technlogies
